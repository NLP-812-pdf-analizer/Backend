<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Визуализация графа из PDF</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #file-input {
            display: none;
        }
        button {
            padding: 20px 180px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 10px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .center {
			text-align: center;
		}
        #graphs-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .graph-wrapper {
            width: 48%;
        }
        .cy-container {
            width: 100%;
            height: 70vh; /* 70% высоты окна */
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            text-align: left; /* Сброс унаследованного выравнивания */
        }
    </style>
</head>
<body>
    <div class="center">
        <h1>Загрузите PDF для обработки в ML</h1>
        <input type="file" id="file-input" accept=".pdf">
        <button id="upload-button">Загрузить PDF</button>
        <div id="status"></div>
    </div>
    
    <div id="graphs-container">
        <div class="graph-wrapper center">
            <h2>Функциональный граф</h2>
            <div id="cy-functional" class="cy-container"></div>
        </div>
        <div class="graph-wrapper center">
            <h2>Иерархический граф</h2>
            <div id="cy-hierarchical" class="cy-container"></div>
        </div>
    </div>
        
    <script>
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const statusDiv = document.getElementById('status');

        /**
         * Отрисовывает граф в указанном контейнере с помощью Cytoscape.js.
         * @param {string} containerId - ID DOM-элемента для графа.
         * @param {object} graphData - Данные графа, полученные с сервера.
         */
        function renderGraph(containerId, graphData) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Очищаем контейнер перед новой отрисовкой

            if (!graphData || !graphData.graph || graphData.graph.length === 0) {
                container.textContent = 'Нет данных для отображения графа.';
                return;
            }

            const nodesSet = new Set();
            const elements = [];

            // Преобразуем данные в формат, понятный Cytoscape
            graphData.graph.forEach(edge => {
                nodesSet.add(edge.source);
                nodesSet.add(edge.target);
                elements.push({
                    group: 'edges',
                    data: {
                        id: `${edge.source}-${edge.target}-${edge.relation}`, // Уникальный ID для ребра
                        source: edge.source,
                        target: edge.target,
                        label: edge.relation
                    }
                });
            });

            nodesSet.forEach(node => {
                elements.push({
                    group: 'nodes',
                    data: { id: node, label: node }
                });
            });

            // Инициализация Cytoscape
            cytoscape({
                container: container,
                elements: elements,
                style: cytoscapeStyle, // Используем общий стиль
                layout: { name: 'cose', animate: true, padding: 10, nodeDimensionsIncludeLabels: true }
            });
        }

        // При нажатии на кнопку "Загрузить PDF", открываем диалог выбора файла
        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        // Когда файл выбран, начинаем загрузку
        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) {
                return;
            }

            statusDiv.textContent = `Загрузка файла: ${file.name}...`;
            statusDiv.className = '';

            const formData = new FormData();
            formData.append('pdfFile', file);

            try {
                const response = await fetch(`/api/graph`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.textContent = 'Файл успешно загружен. Отрисовка графов...';
                    statusDiv.className = 'success';

                    // Отрисовываем оба графа
                    renderGraph('cy-functional', result.functional);
                    renderGraph('cy-hierarchical', result.hierarchical);
                } else {
                    const errorMessage = result.detail || response.statusText;
                    statusDiv.textContent = `Ошибка загрузки: ${errorMessage}`;
                    statusDiv.className = 'error';
                }
            } catch (error) {
                statusDiv.textContent = 'Сетевая ошибка: ' + error.message;
                statusDiv.className = 'error';
            } finally {
                // Сбрасываем значение инпута, чтобы можно было загрузить тот же файл снова
                fileInput.value = '';
            }
        });

        // Общий стиль для графов
        const cytoscapeStyle = [
            {
                selector: 'node',
                style: {
                    'background-color': '#666',
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'color': 'white',
                    'text-outline-width': 2,
                    'text-outline-color': '#666'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': '#ccc',
                    'target-arrow-color': '#ccc',
                    'target-arrow-shape': 'triangle',
                    'label': 'data(label)',
                    'font-size': '10px',
                    'text-background-opacity': 1,
                    'text-background-color': '#fff',
                    'curve-style': 'bezier'
                }
            }
        ];
    </script>
</body>
</html>